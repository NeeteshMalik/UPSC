"use strict";var F=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(o,e)=>{for(var t in e)F(o,t,{get:e[t],enumerable:!0})},ne=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Z(e))!ee.call(o,s)&&s!==t&&F(o,s,{get:()=>e[s],enumerable:!(n=Y(e,s))||n.enumerable});return o};var oe=o=>ne(F({},"__esModule",{value:!0}),o);var de={};te(de,{ShortLinkPlugin:()=>R,default:()=>ce});module.exports=oe(de);var M=require("obsidian");var d=require("obsidian");var A={version:1,shortLinksToFiles:!0,shortLinksToHeadings:!0,showSubheadings:!1,showHash:!1,shortLinksToBlocks:!0,showCaret:!1,showIcons:!0,replaceExternalLinkIcons:!0,iconPosition:"start"},y=class extends d.PluginSettingTab{plugin;constructor(e){super(e.app,e),this.plugin=e}display(){let e=this.plugin.configuration;this.containerEl.empty(),new d.Setting(this.containerEl).setHeading().setName("Notes"),new d.Setting(this.containerEl).setName("Short links to files").setDesc("Only show the file name in links to headings.").addToggle(t=>t.setValue(e.shortLinksToFiles).onChange(n=>{e.shortLinksToFiles=n})),new d.Setting(this.containerEl).setHeading().setName("Headings"),new d.Setting(this.containerEl).setName("Short links to headings").setDesc("Only show the last heading name in links to headings.").addToggle(t=>t.setValue(e.shortLinksToHeadings).onChange(n=>{e.shortLinksToHeadings=n})),new d.Setting(this.containerEl).setName("Show subheadings").setDesc("Show all heading names in links to headings.").addToggle(t=>t.setValue(e.showSubheadings).onChange(n=>{e.showSubheadings=n})),new d.Setting(this.containerEl).setName("Show hash").setDesc("Show the hash at the start of links to headings.").addToggle(t=>t.setValue(e.showHash).onChange(n=>{e.showHash=n})),new d.Setting(this.containerEl).setHeading().setName("Blocks"),new d.Setting(this.containerEl).setName("Short links to blocks").setDesc("Only show the block name in links to blocks.").addToggle(t=>t.setValue(e.shortLinksToBlocks).onChange(n=>{e.shortLinksToBlocks=n})),new d.Setting(this.containerEl).setName("Show caret").setDesc("Show the caret at the start of links to blocks.").addToggle(t=>t.setValue(e.showCaret).onChange(n=>{e.showCaret=n})),new d.Setting(this.containerEl).setHeading().setName("Icons"),new d.Setting(this.containerEl).setName("Show icons").setDesc("Show icons to indicate the type of internal link.").addToggle(t=>t.setValue(e.showIcons).onChange(n=>{e.showIcons=n})),new d.Setting(this.containerEl).setName("Replace external link icons").setDesc("For consistency, replace the default icon used for external links.").addToggle(t=>t.setValue(e.replaceExternalLinkIcons).onChange(n=>{e.replaceExternalLinkIcons=n})),new d.Setting(this.containerEl).setName("Icon position").setDesc("Set whether icons are show at the start or end of links.").addDropdown(t=>t.addOptions({["start"]:"Start",["end"]:"End"}).setValue(e.iconPosition).onChange(n=>{e.iconPosition=n}))}};var D=require("@codemirror/language"),$=require("@codemirror/state"),p=require("@codemirror/view"),_=require("obsidian");var j=require("obsidian");var w=(o,e)=>({from:o,to:e}),V=o=>({from:0,to:o.length}),v=(o,e)=>o.from<=e.to&&o.to>=e.from,x=(o,e)=>o.substring(e.from,e.to);var S={["external"]:"external-link",["internal"]:{["file"]:"file",["heading"]:"hash",["block"]:"box"}},C=o=>{let e=V(o),t=o.indexOf("#"),n=t>=0,s=n?e.from+t:e.to,l=w(e.from,s),r=x(o,l).lastIndexOf("/"),c=r>=0,u=c?l.from+r:l.from,h=w(l.from,u),f=c?Math.min(h.to+1,l.to):l.from,a=w(f,l.to),k=x(o,a).lastIndexOf("."),P=k>=0,I=P?a.from+k:a.to,m=w(a.from,I),L=P?Math.min(m.from+1,a.to):a.from,T=w(L,a.to);if(n){let g=t+1;if(o[g]==="^"){let U=Math.min(g+1,e.to),X=w(U,e.to);return{type:"block",filePath:l,parentPath:h,fileName:a,fileBase:m,fileExtension:T,block:X}}let J=Math.min(g,e.to),b=w(J,e.to),O=x(o,b).lastIndexOf("#"),K=O>=0?Math.min(b.from+O+1,b.to):b.from,Q=w(K,b.to);return{type:"heading",filePath:l,parentPath:h,fileName:a,fileBase:m,fileExtension:T,heading:b,lastHeading:Q}}return{type:"file",filePath:l,parentPath:h,fileName:a,fileBase:m,fileExtension:T}},H=(o,e)=>{let t=(0,j.getIcon)(o);if(t===null)throw new Error(`Failed to get icon: ${o}`);t.removeAttribute("width"),t.removeAttribute("height"),t.removeAttribute("stroke-width"),t.removeClass("svg-icon");let n=document.createElement("span");return n.addClass("link-icon"),n.appendChild(t),n.setAttribute("data-position",e),n};var B=class extends p.WidgetType{iconId;iconPosition;constructor(e,t){super(),this.iconId=e,this.iconPosition=t}eq(e){return this.iconId===e.iconId&&this.iconPosition===e.iconPosition}toDOM(){return H(this.iconId,this.iconPosition)}},q=(o,e)=>Object.fromEntries(Object.entries(o).map(([t,n])=>[t,e(n)])),re=(o,e)=>q(o,t=>typeof t=="object"?q(t,e):e(t)),le=o=>re(S,e=>p.Decoration.widget({side:o==="start"?0:1,widget:new B(e,o)})),z=({tree:o,range:e,enter:t})=>{let n=o.cursor();do if(!(v(e,n)&&(t(n),n.firstChild()))){for(;!n.nextSibling();)if(!n.parent())return}while(!0)},W=(o,e,t)=>{let n=new $.RangeSetBuilder,s=(0,D.syntaxTree)(o.state);for(let l of o.visibleRanges)z({tree:s,range:l,enter(i){if(i.name.contains("formatting-link_link")){let r=i.from;for(;i.nextSibling()&&!i.name.contains("formatting-link-string"););for(;i.nextSibling()&&!i.name.contains("formatting-link-string"););let c=i.to;if(e.showIcons&&e.replaceExternalLinkIcons){let u=e.iconPosition==="start"?r:c,h=t["external"];n.add(u,u,h)}}if(i.name.contains("formatting-link-start")&&!i.name.contains("footref")){let r=i.from,c=i.to;for(;i.nextSibling()&&!i.name.contains("formatting-link-end"););let u=i.from,h=i.to,f=o.state.sliceDoc(c,u),[a,...E]=f.split("|");if(a===void 0)throw new Error(`Failed to get path: ${f}`);let k=E.length>0,P=v.bind(void 0,{from:r,to:h}),I=o.state.selection.ranges.some(P),m=C(a),L=e.iconPosition==="start"?r:h,T=t["internal"][m.type];switch(e.showIcons&&e.iconPosition==="start"&&n.add(L,L,T),m.type){case"heading":if(e.shortLinksToHeadings&&!k&&!I){let g=c;e.showSubheadings?g+=m.heading.from:g+=m.lastHeading.from,e.showHash&&(g-=1),n.add(c,g,p.Decoration.replace({}))}break;case"block":if(e.shortLinksToBlocks&&!k&&!I){let g=c+m.block.from;e.showCaret&&(g-=1),n.add(c,g,p.Decoration.replace({}))}break}if(e.shortLinksToFiles&&!k&&!I){let g=c+m.fileName.from;n.add(c,g,p.Decoration.replace({}))}e.showIcons&&e.iconPosition==="end"&&n.add(L,L,T)}}});return n.finish()},N=o=>p.ViewPlugin.define(e=>{let t=le(o.configuration.iconPosition),n=W(e,o.configuration,t);return{decorationMap:t,decorationSet:n,update(s){s.view.composing||s.view.plugin(_.livePreviewState)?.mousedown?this.decorationSet=this.decorationSet.map(s.changes):(s.selectionSet||s.viewportChanged)&&(this.decorationSet=W(s.view,o.configuration,this.decorationMap))}}},{decorations(e){return e.decorationSet}}),ve=p.ViewPlugin.define(()=>({update(o){if(o.selectionSet||o.viewportChanged){console.clear();let e=(0,D.syntaxTree)(o.view.state);for(let t of o.view.visibleRanges)z({tree:e,range:t,enter(n){if(n.name.contains("Document"))return;let s=v.bind(void 0,n);if(o.view.state.selection.ranges.some(s)){let i=o.view.state.sliceDoc(n.from,n.to);console.log(n.name,i)}}})}}}));var G=o=>e=>{let t=o.configuration,n=(i,r)=>{let c=H(r,t.iconPosition);t.iconPosition==="start"?i.prepend(c):t.iconPosition==="end"&&i.append(c)},s=e.querySelectorAll("a.external-link");for(let i of s)t.showIcons&&t.replaceExternalLinkIcons&&n(i,S["external"]);let l=e.querySelectorAll("a.internal-link");for(let i of l){let r=i.getAttribute("href");if(r===null)continue;let h=i.getAttribute("aria-label")?.replace(".md","")!==i.getText(),f=C(r);if(t.shortLinksToFiles&&!h){let a=x(r,f.fileBase);i.setText(a)}switch(f.type){case"heading":let a;t.showSubheadings?a=x(r,f.heading).split("#").join(" > "):a=x(r,f.lastHeading),h||(t.shortLinksToHeadings?i.setText(a):t.shortLinksToFiles&&i.appendText(" > "+a));break;case"block":let E={...f.block};t.showCaret&&(E.from-=1);let k=x(r,E);h||(t.shortLinksToBlocks?i.setText(k):t.shortLinksToFiles&&i.appendText(" > "+k));break}t.showIcons&&n(i,S["internal"][f.type])}};var R=class extends M.Plugin{configuration;settingTab=new y(this);editorExtension=new Array(N(this));markdownPostProcessor=G(this);async onload(){await this.loadSettings(),this.addSettingTab(this.settingTab),this.registerEditorExtension(this.editorExtension),this.registerMarkdownPostProcessor(this.markdownPostProcessor),this.updateBody(),this.updateEditor()}async onunload(){this.updateBody(!0),this.updateEditor(),await this.saveSettings()}async loadSettings(){let e=await this.loadData(),t={...A,...e};this.configuration=new Proxy(t,{set:(n,s,l,i)=>{let r=Reflect.set(n,s,l,i);return r&&(this.updateBody(),this.updateEditor(),this.saveSettings()),r}})}async saveSettings(){await this.saveData(this.configuration)}updateBody(e=!1){let t="hide-external-link-icon";this.configuration.replaceExternalLinkIcons&&!e?document.body.classList.add(t):document.body.classList.remove(t)}updateEditor(){this.editorExtension.length=0,this.editorExtension.push(N(this)),this.app.workspace.updateOptions(),this.app.workspace.iterateAllLeaves(e=>{e.view instanceof M.MarkdownView&&e.view.previewMode.rerender(!0)})}},ce=R;0&&(module.exports={ShortLinkPlugin});
